/* DTM Smart Function Test Runners - Standalone Package */
var e=require("fs"),t=require("path"),o=require("typescript"),r=require("vm");function s(e){var t=Object.create(null);return e&&Object.keys(e).forEach(function(o){if("default"!==o){var r=Object.getOwnPropertyDescriptor(e,o);Object.defineProperty(t,o,r.get?r:{enumerable:!0,get:function(){return e[o]}})}}),t.default=e,Object.freeze(t)}var n=s(o),i=s(r);const a={timeoutMs:parseInt(process.env.SMART_FUNCTION_TIMEOUT_MS||"1000",10),memoryLimitMb:parseInt(process.env.SMART_FUNCTION_MEMORY_LIMIT_MB||"50",10),stackSizeMb:parseInt(process.env.SMART_FUNCTION_STACK_SIZE_MB||"1",10),workerOldGenerationMb:parseInt(process.env.SMART_FUNCTION_WORKER_OLD_GEN_MB||"50",10),workerYoungGenerationMb:parseInt(process.env.SMART_FUNCTION_WORKER_YOUNG_GEN_MB||"10",10),workerCodeRangeMb:parseInt(process.env.SMART_FUNCTION_WORKER_CODE_RANGE_MB||"10",10),workerInitTimeoutMs:parseInt(process.env.SMART_FUNCTION_WORKER_INIT_TIMEOUT_MS||"10000",10),maxPoolSize:parseInt(process.env.SMART_FUNCTION_MAX_POOL_SIZE||"100",10),enableCodeSwapping:"true"===process.env.SMART_FUNCTION_ENABLE_CODE_SWAPPING,fixedPoolSize:parseInt(process.env.SMART_FUNCTION_FIXED_POOL_SIZE||"10",10)},c={timeout:a.timeoutMs,displayErrors:!0,microtaskMode:"afterEvaluate"},u={JSON:JSON,Math:Math,Date:Date,Array:Array,Object:Object,String:String,Number:Number,Boolean:Boolean,Promise:Promise,TextEncoder:global.TextEncoder||TextEncoder,TextDecoder:global.TextDecoder||TextDecoder,setTimeout:setTimeout,setInterval:setInterval,setImmediate:setImmediate,clearTimeout:clearTimeout,clearInterval:clearInterval,clearImmediate:clearImmediate,require:void 0,global:{}},l={name:"Dtm-Sfn-Sandbox",codeGeneration:{strings:!1,wasm:!1},microtaskMode:"afterEvaluate"};function m(e){return!(!e||"object"!=typeof e)&&"cumulocityType"in e&&"measurement"===e.cumulocityType&&"payload"in e&&"object"==typeof e.payload}function p(e,t=new WeakSet){return null===e||"object"!=typeof e||t.has(e)||(t.add(e),Object.freeze(e),Object.values(e).forEach(e=>{null!==e&&"object"==typeof e&&p(e,t)})),e}class h{constructor(e={}){this.consoleLogs=[],this.lastExecutionTimeMs=void 0,this.options={timeout:e.timeout??a.timeoutMs,memoryLimitMb:0,stackSizeMb:0,captureConsole:e.captureConsole??!1,console:e.console},this.logger=e.logger}getName(){return"nodejs-vm"}getLastExecutionTimeMs(){return this.lastExecutionTimeMs}async initialize(){}async execute(e,t,o,r={},s){this.options.captureConsole&&(this.consoleLogs=[]);const n=function(e={}){const{captureConsole:t=!1,console:o,consoleLogs:r}=e;let s;return s=t&&r?function(e){const t=t=>(...o)=>{e.push({level:t,args:o,timestamp:Date.now()})};return{log:t("log"),warn:t("warn"),error:t("error"),debug:t("debug"),verbose:t("verbose")}}(r):o?function(e){return{log:(...t)=>e.log(...t),warn:(...t)=>e.warn(...t),error:(...t)=>e.error(...t),debug:(...t)=>e.debug(...t),verbose:(...t)=>e.verbose(...t)}}(o):function(){const e=()=>{};return{log:e,warn:e,error:e,debug:e,verbose:e}}(),{console:s,utilities:{isMeasurement:m}}}({captureConsole:this.options.captureConsole,console:s||this.options.console,consoleLogs:this.consoleLogs}),a=this.createSandbox(n.console,n.utilities),c=i.createContext(a,l);return this.executeCodeInContext(c,e,"smart-function.js"),await this.executeFunctionInContext(c,t,o,r)}getConsoleLogs(){return[...this.consoleLogs]}clearConsoleLogs(){this.consoleLogs=[]}dispose(){this.consoleLogs=[]}createSandbox(e,t){return{...u,Promise:Promise,exports:{},module:{exports:{}},console:e,...t}}executeCodeInContext(e,t,o){new i.Script(t,{filename:o}).runInContext(e,{...c,timeout:this.options.timeout})}async executeFunctionInContext(e,t,o,r){if("function"!=typeof e.exports[t])throw new Error(`Function ${t} not exported or not a function`);const s=p(o),n=p(r);e.__executionInput=s,e.__executionContext=n,e.__executionResult=void 0;const a=performance.now();new i.Script(`__executionResult = exports.${t}(__executionInput, __executionContext);`,{filename:"smart-function-execution"}).runInContext(e,{...c,timeout:this.options.timeout});let u=e.__executionResult;return u&&"function"==typeof u.then&&(u=await u),this.lastExecutionTimeMs=performance.now()-a,delete e.__executionInput,delete e.__executionContext,delete e.__executionResult,u}}exports.OnMessageFnName="onMessage",exports.SmartFunctionsRunner=class{constructor(e){this.options={captureConsole:!0,timeout:5e3,baseDir:process.cwd(),...e},this.transpiledCode=this.loadAndTranspile(),this.engine=this.createEngine()}loadAndTranspile(){const o=null!=this.options.sourceFile&&t.isAbsolute(this.options.sourceFile)?this.options.sourceFile:t.resolve(this.options.baseDir,this.options.sourceFile);if(!e.existsSync(o))throw new Error(`Smart function file not found: ${o}`);let r=e.readFileSync(o,"utf-8");if(o.endsWith(".js"))return r;if(o.endsWith(".ts")){const e={module:n.ModuleKind.CommonJS,target:n.ScriptTarget.ES2021,sourceMap:!0,inlineSourceMap:!0,inlineSources:!0,...this.options.compilerOptions};return n.transpileModule(r,{compilerOptions:e}).outputText}throw new Error(`Unsupported file extension for smart function: ${o}. Supported extensions are .ts and .js`)}createEngine(){const e={timeout:this.options.timeout,memoryLimitMb:this.options.memoryLimitMb,stackSizeMb:this.options.stackSizeMb,captureConsole:this.options.captureConsole||!0,console:this.options.console};return new h(e)}async initialize(){this.engine.initialize&&await this.engine.initialize()}async execute(e,t,o={}){return!o.console&&this.options.console&&(o.console=this.options.console),this.engine.execute(this.transpiledCode,e,t,o)}getConsoleLogs(){return"getConsoleLogs"in this.engine&&"function"==typeof this.engine.getConsoleLogs&&this.engine.getConsoleLogs()||[]}getTranspiledCode(){return this.transpiledCode}dispose(){this.engine.dispose()}},exports.isMeasurement=m;