/* DTM Smart Function Test Runners - Standalone Package */
var e=require("fs"),t=require("path"),o=require("typescript"),r=require("vm");function s(e){var t=Object.create(null);return e&&Object.keys(e).forEach(function(o){if("default"!==o){var r=Object.getOwnPropertyDescriptor(e,o);Object.defineProperty(t,o,r.get?r:{enumerable:!0,get:function(){return e[o]}})}}),t.default=e,Object.freeze(t)}var n=s(o),i=s(r);const a={timeoutMs:parseInt(process.env.SMART_FUNCTION_TIMEOUT_MS||"1000",10),memoryLimitMb:parseInt(process.env.SMART_FUNCTION_MEMORY_LIMIT_MB||"50",10),stackSizeMb:parseInt(process.env.SMART_FUNCTION_STACK_SIZE_MB||"1",10),workerOldGenerationMb:parseInt(process.env.SMART_FUNCTION_WORKER_OLD_GEN_MB||"50",10),workerYoungGenerationMb:parseInt(process.env.SMART_FUNCTION_WORKER_YOUNG_GEN_MB||"10",10),workerCodeRangeMb:parseInt(process.env.SMART_FUNCTION_WORKER_CODE_RANGE_MB||"10",10),workerInitTimeoutMs:parseInt(process.env.SMART_FUNCTION_WORKER_INIT_TIMEOUT_MS||"10000",10)},c={timeout:a.timeoutMs,displayErrors:!0,microtaskMode:"afterEvaluate"},u={JSON:JSON,Math:Math,Date:Date,Array:Array,Object:Object,String:String,Number:Number,Boolean:Boolean,Promise:Promise,TextEncoder:global.TextEncoder||TextEncoder,TextDecoder:global.TextDecoder||TextDecoder,setTimeout:setTimeout,setInterval:setInterval,setImmediate:setImmediate,clearTimeout:clearTimeout,clearInterval:clearInterval,clearImmediate:clearImmediate,require:void 0,global:{}},l={name:"Dtm-Sfn-Sandbox",codeGeneration:{strings:!1,wasm:!1},microtaskMode:"afterEvaluate"};function p(){const e=()=>{};return{log:e,warn:e,error:e,debug:e,verbose:e,info:e}}function m(e){return null===e||"object"!=typeof e||(Object.freeze(e),Object.values(e).forEach(e=>{null!==e&&"object"==typeof e&&m(e)})),e}class h{constructor(e={}){this.consoleLogs=[],this.options={timeout:e.timeout??a.timeoutMs,memoryLimitMb:0,stackSizeMb:0,captureConsole:e.captureConsole??!1,console:e.console??p()}}getName(){return"nodejs-vm"}async initialize(){}async execute(e,t,o,r={}){this.options.captureConsole&&(this.consoleLogs=[]);const s=function(e,t){return e.includes("Object.defineProperty(exports")||e.includes("exports.")||e.includes("module.exports")?e:e.replace(/^\s*export\s+function\s+(\w+)/gm,"function $1").replace(/^\s*export\s+const\s+(\w+)/gm,"const $1").replace(/^\s*export\s+\{([^}]+)\}/gm,(e,t)=>t.split(",").map(e=>e.trim()).map(e=>`exports.${e} = ${e};`).join("\n"))+`\n\nif (typeof exports === 'undefined') { var exports = {}; }\nexports.${t} = ${t};`}(e,t);!function(e,t){if(!e||0===e.trim().length)throw new Error(`No or empty function source code${t?` for ${t}`:""}. Expecting valid JavaScript code.`);const o=require("vm");try{new o.Script(e,{filename:t||"smart-function"})}catch(e){throw new Error(`Invalid JavaScript syntax${t?` in ${t}`:""}: ${e.message}`)}}(s,t);const n=this.createConsoleProxy(),a=this.createSandbox(n),c=i.createContext(a,l);return this.executeCodeInContext(c,s,"smart-function.js"),await this.executeFunctionInContext(c,t,o,r,n)}async executeWithLogs(e,t,o,r={}){const s=Date.now(),n=this.options.captureConsole;this.options.captureConsole=!0,this.consoleLogs=[];try{const n=await this.execute(e,t,o,r),i=Date.now()-s;return{result:n,logs:[...this.consoleLogs],executionTimeMs:i}}finally{this.options.captureConsole=n}}getConsoleLogs(){return[...this.consoleLogs]}clearConsoleLogs(){this.consoleLogs=[]}dispose(){this.consoleLogs=[]}createConsoleProxy(){const e=e=>(...t)=>{this.options.captureConsole&&this.consoleLogs.push({level:e,args:t,timestamp:Date.now()}),this.options.console&&this.options.console[e]&&this.options.console[e](...t)};return{log:e("log"),warn:e("warn"),error:e("error"),debug:e("debug"),info:e("info"),verbose:e("verbose")}}createSandbox(e){return{...u,Promise:Promise,exports:{},module:{exports:{}},console:e}}executeCodeInContext(e,t,o){new i.Script(t,{filename:o}).runInContext(e,{...c,timeout:this.options.timeout})}async executeFunctionInContext(e,t,o,r,s){if("function"!=typeof e.exports[t])throw new Error(`Function ${t} not exported or not a function`);const n={...r,console:s},a=m(o),u=m(n);e.__executionInput=a,e.__executionContext=u,e.__executionResult=void 0,new i.Script(`__executionResult = exports.${t}(__executionInput, __executionContext);`,{filename:"smart-function-execution"}).runInContext(e,{...c,timeout:this.options.timeout});let l=e.__executionResult;return l&&"function"==typeof l.then&&(l=await l),delete e.__executionInput,delete e.__executionContext,delete e.__executionResult,l}}exports.OnMessageFnName="onMessage",exports.SmartFunctionsRunner=class{constructor(e){this.options={captureConsole:!0,timeout:5e3,baseDir:process.cwd(),...e},this.transpiledCode=this.loadAndTranspile(),this.engine=this.createEngine()}loadAndTranspile(){const o=null!=this.options.sourceFile&&t.isAbsolute(this.options.sourceFile)?this.options.sourceFile:t.resolve(this.options.baseDir,this.options.sourceFile);if(!e.existsSync(o))throw new Error(`Smart function file not found: ${o}`);let r=e.readFileSync(o,"utf-8");if(o.endsWith(".js"))return r;if(o.endsWith(".ts")){const e={module:n.ModuleKind.CommonJS,target:n.ScriptTarget.ES2021,sourceMap:!0,inlineSourceMap:!0,inlineSources:!0,...this.options.compilerOptions};return n.transpileModule(r,{compilerOptions:e}).outputText}throw new Error(`Unsupported file extension for smart function: ${o}. Supported extensions are .ts and .js`)}createEngine(){const e={timeout:this.options.timeout,memoryLimitMb:this.options.memoryLimitMb,stackSizeMb:this.options.stackSizeMb,captureConsole:this.options.captureConsole,console:this.options.console};return new h(e)}async initialize(){this.engine.initialize&&await this.engine.initialize()}async execute(e,t,o={}){return!o.console&&this.options.console&&(o.console=this.options.console),this.engine.execute(this.transpiledCode,e,t,o)}async executeWithLogs(e,t,o={}){return!o.console&&this.options.console&&(o.console=this.options.console),this.engine.executeWithLogs(this.transpiledCode,e,t,o)}getTranspiledCode(){return this.transpiledCode}dispose(){this.engine.dispose()}},exports.isMeasurement=function(e){return!(!e||"object"!=typeof e)&&"cumulocityType"in e&&"payload"in e&&"object"==typeof e.payload};